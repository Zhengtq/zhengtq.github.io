<!DOCTYPE html>
<html lang="zh-cn">
<head><meta name="generator" content="Hexo 3.8.0">

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no">
<meta name="author" content="Billy">



<meta name="description" content="Let firstly simplify the Quant process in TFOverview1S_a1(q_a1 + Z_a1) = S_w1(q_w1 + Z_w1) * S_a0(q_a0 + Z_a0)  q_a1: Quanted activation value in layer 1 S_a1, Z_a1:  Estimated scale and zero point in">
<meta name="keywords" content="Deeplearning,Tensorflow">
<meta property="og:type" content="article">
<meta property="og:title" content="&lt; Tensorflow &gt;How dose TensorFlow do Quant Aware Training?">
<meta property="og:url" content="http://yoursite.com/2019/03/25/tf-quant/index.html">
<meta property="og:site_name" content="Billy&#39;s Blog">
<meta property="og:description" content="Let firstly simplify the Quant process in TFOverview1S_a1(q_a1 + Z_a1) = S_w1(q_w1 + Z_w1) * S_a0(q_a0 + Z_a0)  q_a1: Quanted activation value in layer 1 S_a1, Z_a1:  Estimated scale and zero point in">
<meta property="og:locale" content="zh-cn">
<meta property="og:updated_time" content="2021-03-12T06:44:17.371Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="&lt; Tensorflow &gt;How dose TensorFlow do Quant Aware Training?">
<meta name="twitter:description" content="Let firstly simplify the Quant process in TFOverview1S_a1(q_a1 + Z_a1) = S_w1(q_w1 + Z_w1) * S_a0(q_a0 + Z_a0)  q_a1: Quanted activation value in layer 1 S_a1, Z_a1:  Estimated scale and zero point in">

<link rel="apple-touch-icon" href="/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="Billy&#39;s Blog" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>&lt; Tensorflow &gt;How dose TensorFlow do Quant Aware Training? | Billy&#39;s Blog</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: 
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Billy</a></h1>
        </hgroup>

        
        <p class="header-subtitle">Make It Simple</p>
        

        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>Menu</li>
                        <li>Tags</li>
                        
                        <li>Friends</li>
                        
                        
                        <li>About Me</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:123@123.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Antispoofing/">Antispoofing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C-C/">C/C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DEMO/">DEMO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Deeplearning/">Deeplearning</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NCNN/">NCNN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Other/">Other</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RNN/">RNN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tensorflow/">Tensorflow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">专注于前端</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Billy</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Billy</a></h1>
            </hgroup>
            
            <p class="header-subtitle">Make It Simple</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:123@123.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="Tags" friends="Friends" about="About Me">
</nav>
      <div class="body-wrap"><article id="post-tf-quant" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/03/25/tf-quant/" class="article-date">
      <time datetime="2019-03-25T09:22:38.000Z" itemprop="datePublished">2019-03-25</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      &lt; Tensorflow &gt;How dose TensorFlow do Quant Aware Training?
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Deeplearning/">Deeplearning</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Deeplearning/">Deeplearning</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tensorflow/">Tensorflow</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Let-firstly-simplify-the-Quant-process-in-TF"><a href="#Let-firstly-simplify-the-Quant-process-in-TF" class="headerlink" title="Let firstly simplify the Quant process in TF"></a>Let firstly simplify the Quant process in TF</h1><h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">S_a1(q_a1 + Z_a1) = S_w1(q_w1 + Z_w1) * S_a0(q_a0 + Z_a0)</span><br></pre></td></tr></table></figure>
<ul>
<li>q_a1: Quanted activation value in layer 1</li>
<li><p>S_a1, Z_a1:  <strong>Estimated</strong> scale and zero point in layer 1</p>
</li>
<li><p>q_w1: Quanted weight in layer 1</p>
</li>
<li><p>S_w1, Z_w1:  <strong>Statistical</strong> scale and zero point in layer 1</p>
</li>
<li><p>q_a0: Quanted activation value in layer 0</p>
</li>
<li>S_a0, Z_a0:  <strong>Estimated</strong> scale and zero point in layer 0</li>
</ul>
<p>As we can see, in order to compute q_a1(Quanted activation value in layer 1), we have to get S_w1, Z_w1, S_a0, Z_a0, q_a1, Z_a1. To get S_w1/Z_w1 is simple, we can get the Statistical maximum of the weights in each layer we want. The only tricky thing is how to get S_a1/Z_a1/S_a0/Z_a0, which have to be estimated from the training data.<br><a id="more"></a></p>
<h3 id="Why-we-have-to-get-the-estimation-of-S-Z-after-activation-instead-of-before"><a href="#Why-we-have-to-get-the-estimation-of-S-Z-after-activation-instead-of-before" class="headerlink" title="Why we have to get the estimation of S/Z after activation instead of before?"></a>Why we have to get the estimation of S/Z after activation instead of before?</h3><p>Of course we can estimate the S/Z before activation. And then we activate(Relu) the quantized value. However, there is one drawbacks:</p>
<p>Estimate S/Z before activation<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conv -&gt;  (before activation)estimate S/Z=[0-&gt;255] -&gt; truncation（relu）= [Z-&gt;255] (if relu6 : [Z-&gt;X])</span><br></pre></td></tr></table></figure></p>
<p>Estimate S/Z after activation<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conv -&gt;  (after activation)estimate S/Z=[-A-&gt;A] -&gt; truncation（relu）= [0-&gt;255](if relu6: [0-&gt;255])</span><br></pre></td></tr></table></figure></p>
<p>As we can see,  after activation, the range of activation value for estimating S/Z is always 0 to 255. However, when we estimate S/Z before activation, the range of  activation value for estimating S/Z is narrow than 0 to 255. So if we estimate S/Z before activation, the quantized activated is compressed even wore  which could lead to accuracy loss.</p>
<h1 id="Quantization-aware-training-in-Tensorflow"><a href="#Quantization-aware-training-in-Tensorflow" class="headerlink" title="Quantization aware training in Tensorflow"></a>Quantization aware training in Tensorflow</h1><p>You can either train your quantized model by restoring a ever trained floating point model or from scratch. In any cases, you have to create a quantization training graph first.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tf.contrib.quantize.create_training_graph(quant_delay=DELAY_STEP)</span><br></pre></td></tr></table></figure></p>
<p>The <em>DELAY_STEP</em> means the number of steps that you want your normal floating point training sustain. So after the DELAY_STEP of normal training, the quantization aware training would be started.  </p>
<p>If you use multi-GPU to training your network, you have to create a new quantization graph on every GPU card. Just like these code below:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> tf.variable_scope(tf.get_variable_scope()):</span><br><span class="line">     <span class="keyword">for</span> i <span class="keyword">in</span> xrange(len(GPU_NUM_ID)):</span><br><span class="line">          <span class="keyword">with</span> tf.device(<span class="string">'/gpu:%d'</span> % GPU_NUM_ID[i]):</span><br><span class="line">                <span class="keyword">with</span> tf.name_scope(<span class="string">'%s_%d'</span> % (<span class="string">'cnn_mg'</span>, i)) <span class="keyword">as</span> scope:</span><br><span class="line">                            images, abels = load_batch_images()           </span><br><span class="line">                            logits, out_data = net.inference(images, reuse=tf.AUTO_REUSE,  num_classes=LABEL_NUM)</span><br><span class="line">                            <span class="keyword">with</span> tf.variable_scope(tf.get_variable_scope(), reuse=tf.AUTO_REUSE):</span><br><span class="line">                                tf.contrib.quantize.create_training_graph(quant_delay=DELAY_STEP)</span><br><span class="line">                            loss = conpute_loss(labels, logits)</span><br><span class="line">                            tf.get_variable_scope().reuse_variables()</span><br><span class="line">                            grads = optimizer.compute_gradients(loss_total_sep)</span><br><span class="line">                            tower_grads.append(grads)</span><br></pre></td></tr></table></figure>
<p>One thing I have to mention is that the quantized aware training process is fake training.</p>
<p>Fake training means that during the forward step,  the training graph just simulate the integer multiply by using corresponding floating point multiply.</p>
<p>The word ‘Corresponding’ means that the simulated float weights are the inverse quantization value of the corresponding fixed integer. </p>
<p>So the forward result may be slightly different from the actual quantization computed result.</p>
<h1 id="Save-Frozen-Convert-and-Test"><a href="#Save-Frozen-Convert-and-Test" class="headerlink" title="Save, Frozen, Convert and Test"></a>Save, Frozen, Convert and Test</h1><h2 id="Save"><a href="#Save" class="headerlink" title="Save"></a>Save</h2><p>When finishing quantization aware training, you have to save your trained quantized model.</p>
<p>To save your quantized model, you have to create a quantized evaluation graph by using the following code:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">g = tf.get_default_graph()</span><br><span class="line">tf.contrib.quantize.create_eval_graph(input_graph=g)</span><br></pre></td></tr></table></figure>
<p>Then just get the graph and save it.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">'./your_quantized_graph.pb'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">       f.write(str(g.as_graph_def()))\</span><br></pre></td></tr></table></figure></p>
<h2 id="Frozen"><a href="#Frozen" class="headerlink" title="Frozen"></a>Frozen</h2><p>To make your model more compact, you can froze your model. Frozen a model means that getting rid of useless operations and fusing redundant operations. To froze your graph, you can use the standard frozen tool.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bazel build tensorflow/python/tools:freeze_graph &amp;&amp; \</span><br><span class="line">bazel-bin/tensorflow/python/tools/freeze_graph \</span><br><span class="line">--input_graph=some_graph_def.pb \</span><br><span class="line">--input_checkpoint=model.ckpt-8361242 \</span><br><span class="line">--output_graph=/tmp/frozen_graph.pb --output_node_names=softmax</span><br></pre></td></tr></table></figure></p>
<h2 id="Convert"><a href="#Convert" class="headerlink" title="Convert"></a>Convert</h2><p>The next step is to convert your frozen graph to tflite for future deploy.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">path_to_frozen_graphdef_pb = <span class="string">'./your_frozen_graph.pb'</span></span><br><span class="line">input_shapes = &#123;<span class="string">'validate_input/imgs'</span>:[<span class="number">1</span>,<span class="number">320</span>,<span class="number">320</span>,<span class="number">3</span>]&#125;</span><br><span class="line">(tf_verion&gt;<span class="number">1.11</span>)converter = tf.contrib.lite.TFLiteConverter.from_frozen_graph(path_to_frozen_graphdef_pb, [<span class="string">'validate_input/imgs'</span>], [<span class="string">'output_node'</span>])</span><br><span class="line">(tf_version&lt;=<span class="number">1.11</span>)converter = tf.contrib.lite.TocoConverter.from_frozen_graph(path_to_frozen_graphdef_pb, [<span class="string">'validate_input/imgs'</span>], [<span class="string">'output_node'</span>])</span><br><span class="line">converter.inference_type = tf.contrib.lite.constants.QUANTIZED_UINT8</span><br><span class="line">converter.quantized_input_stats = &#123;<span class="string">'validate_input/imgs'</span>:(<span class="number">0.</span>,<span class="number">1.</span>)&#125;</span><br><span class="line">converter.allow_custom_ops = <span class="keyword">True</span></span><br><span class="line">converter.default_ranges_stats = (<span class="number">0</span>,<span class="number">255</span>)</span><br><span class="line">converter.post_training_quantize = <span class="keyword">True</span></span><br><span class="line">tflite_model = converter.convert()</span><br><span class="line">open(<span class="string">"sfnv2.tflite"</span>, <span class="string">"wb"</span>).write(tflite_model)</span><br></pre></td></tr></table></figure></p>
<h2 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h2><p>Finally, your can test your converted tflite. By using the following code, you can test your quantized model:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">interpreter = tf.contrib.lite.Interpreter(model_path=<span class="string">"your.tflite"</span>) </span><br><span class="line">interpreter.allocate_tensors() </span><br><span class="line">input_details = interpreter.get_input_details() </span><br><span class="line">output_details = interpreter.get_output_details() </span><br><span class="line">interpreter.set_tensor(input_details[<span class="number">0</span>][<span class="string">'index'</span>], batch_validate_img)</span><br><span class="line">interpreter.invoke()</span><br><span class="line">score = interpreter.get_tensor(output_details[<span class="number">0</span>][<span class="string">'index'</span>])</span><br><span class="line">score = score[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">zero_point = xxx</span><br><span class="line">scale = xxx</span><br><span class="line">reverse_socre = scale  * (score - zero_point)</span><br></pre></td></tr></table></figure></p>
<p>One thing to mention is that the final score you get is a fixed point integer value. </p>
<p>You have to convert the fixed point integer value to the corresponding float value. </p>
<p>In order to do that, you have to check the corresponding zero point and scale in the corresponding output layer and then you can transfer the fixed point integer value to get the final float value.</p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>Title:</span><a href="/2019/03/25/tf-quant/">&lt; Tensorflow &gt;How dose TensorFlow do Quant Aware Training?</a></p>
        <p><span>Author:</span><a href="/" title="Back to Homepage">Billy</a></p>
        <p><span>Created:</span>2019-03-25, 17:22:38</p>
        <p><span>Updated:</span>2021-03-12, 14:44:17</p>
        <p>
            <span>Full URL:</span><a class="post-url" href="/2019/03/25/tf-quant/" title="&lt; Tensorflow &gt;How dose TensorFlow do Quant Aware Training?">http://yoursite.com/2019/03/25/tf-quant/</a>
            <span class="copy-path" data-clipboard-text="From http://yoursite.com/2019/03/25/tf-quant/　　By Billy" title="Copy Article&#39;s Link &amp; Author"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>License:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target="_blank">"CC BY-NC-SA 4.0"</a> Keep Link &amp; Author if Distribute.
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2019/03/29/network-depthwise/">
                    &lt; Network &gt; Understanding DepthWiseConv
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2019/03/16/antispoof-multi-task-learn/">
                    &lt; Antispoofing &gt; Multi-Task-Learning in Face Antispoofing
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Let-firstly-simplify-the-Quant-process-in-TF"><span class="toc-number">1.</span> <span class="toc-text">Let firstly simplify the Quant process in TF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Overview"><span class="toc-number">1.0.1.</span> <span class="toc-text">Overview</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Why-we-have-to-get-the-estimation-of-S-Z-after-activation-instead-of-before"><span class="toc-number">1.0.2.</span> <span class="toc-text">Why we have to get the estimation of S/Z after activation instead of before?</span></a></li></ol></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#Quantization-aware-training-in-Tensorflow"><span class="toc-number">2.</span> <span class="toc-text">Quantization aware training in Tensorflow</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Save-Frozen-Convert-and-Test"><span class="toc-number">3.</span> <span class="toc-text">Save, Frozen, Convert and Test</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Save"><span class="toc-number">3.1.</span> <span class="toc-text">Save</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Frozen"><span class="toc-number">3.2.</span> <span class="toc-text">Frozen</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Convert"><span class="toc-number">3.3.</span> <span class="toc-text">Convert</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Test"><span class="toc-number">3.4.</span> <span class="toc-text">Test</span></a></li></ol></li>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="Hide" title="Show or Hide Table of Contents">

    <script>
        yiliaConfig.toc = ["Hide", "Show", !!"false"];
    </script>



    
<div class="share">
    
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"< Tensorflow >How dose TensorFlow do Quant Aware Training?　| Billy's Blog　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    

    
</div>







    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2019/03/29/network-depthwise/" title="Pre: &lt; Network &gt; Understanding DepthWiseConv">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="Mini Archives"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2019/03/16/antispoof-multi-task-learn/" title="Next: &lt; Antispoofing &gt; Multi-Task-Learning in Face Antispoofing">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/01/27/tf2-x-best-practice/">< Tensorflow >Tensorflow2.4 最佳实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/28/ncnn-lesson-start/">< NCNN-Lession-Start >　Start</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/21/ncnn-lesson-10/">< NCNN-Lession-10 >　Forward Net</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/21/ncnn-lesson-9/">< NCNN-Lession-9 >　Load Image</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/18/ncnn-lesson-8/">< NCNN-Lession-8 >　读取网络的权重信息</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/15/ncnn-lesson-7/">< NCNN-Lession-7 >　Mat类的实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/11/ncnn-lesson6/">< NCNN-Lession-6 >　内存管理，allocator的实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/10/ncnn-lession-5/">< NCNN-Lession-5 >　create_layer的实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/10/ncnn-lession-4/">< NCNN-Lession-４ >　创建layer子类</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/09/ncnn-lession-3/">< NCNN-Lession-3 >　读取网络的proto信息</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/09/ncnn-lession-2/">< NCNN-Lession-2 >　Net/Layer/Blob</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/08/ncnn-lession-1/">< NCNN-Lession-1 >　数据读取类DataReader</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/13/A-new-FaceQnet/">< Deeplearning > 博采众长，一个更加全面的人脸质量评价库</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/30/pri-knowledge-1/">< Deeplearning > 给模型加入先验知识</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/20/advnoise/">< Deeplearning > TF实操Game of Noise</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/17/advAS/">< Antispoofing >　如何科学的攻破活体识别系统</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/19/saferm/">< Linux > A Safe Way to Use Deletion Command In Linux.</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/27/linux-multi-thread/">< Linux > A simple way to run program with mult-thread</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/27/DEMO/">< DEMO > My work and DEMO</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/15/gru-bp1/">< Deeplarning > Understand Backpropagation of RNN/GRU and Implement It in Pure Python---1</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/24/op-summary/"><deeplarning> A simple way to distinguish different optimizers in DeepLearning</deeplarning></a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/19/motion-blink-rnn/">< Deeplearning > Use CNN and RNN to detect blink in a video</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/19/linux-install-config/">< Linux > As a AI-practitioner, what I install in my linux system</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/29/network-depthwise/">< Network > Understanding DepthWiseConv</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/25/tf-quant/">< Tensorflow >How dose TensorFlow do Quant Aware Training?</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/16/antispoof-multi-task-learn/">< Antispoofing > Multi-Task-Learning in Face Antispoofing</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/06/dataset-cut/">< DeepLearning > The Support Vectors in DeepLearning</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/01/face-as-1/">< Antispoofing > Data Augmentation in Face Antispoofing</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/30/face-as/">< Antispoofing > Does we should align in Face Antispoofing</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/09/tf-read-data/">< Tensorflow > Data flow in Tensorflow</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/05/tf-rnn-gru/">< Tensorflow > What is the implementation of GRU in tensorflow</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/03/softmax-sigmoid-cross-entropy/">< Tensorflow > Softmax cross entropy & Sigmoid cross entropy</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/02/dl-question/"><deeplarning> Some DeepLearning Questions to Think About</deeplarning></a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/30/tf-lsoftmax/">< Tensorflow > How to implement the larget margin softmax loss in tensorflow.</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/22/tf-rgb-disturb/">< Tensorflow >Tensorflow Data Augmentation RGB distortation</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/20/tf-tur-perspective-transform/">< Tensorflow >Tensorflow Data Augmentation affine transformation</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/14/newwork/">< Network > Understanding the activation style in residual block</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/11/LINUX-COMMOND/">< Linux > Commond</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/09/bp-simple/">< Deeplearning > Break up backpropagation</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/05/python-tricks-1/">< Python > Some python tricks you may never use But you should know</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/02/tensorflow-disturb-yuv/">< Tensorflow >Tensorflow Data Augmentation YUV distortation</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/30/c-c-1/">< C\C++ > Compile on linux</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/28/network-shufflenet-v2/">< Network > Understanding Shufflenet_v2</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/26/algorithm-hash-table/">< Algorithm > Hash table and decision tree</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/04/py-check/">< Python > To check elements in Python</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016-2021 Billy
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="A fast, simple &amp; powerful blog framework">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="Another simple and elegant theme for Hexo  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style="display:none">
                        <span id="site-visit" title="Site Visitors"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style="display:none">
                        <span id="page-visit" title="Page Hits"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="Back to Top"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="Comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="Go to Bottom"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>